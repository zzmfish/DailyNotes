---
layout: posts
title: Bazel
tags: 开发工具
---


## 概念

#### Workspace

* 包含软件`源代码`
* 包含`输出目录`的符号链接
* 包含`WORKSPACE文件`指明外部依赖
* 包含WORKSPACE文件的目录是workspace的`根目录`
* 忽略子目录的WORKSPACE文件
* 可以是`WORKSPACE.bazel`

#### Repositories

* 仓库用来`组织代码`
* 根目录又称`主仓库`或`@`
* `外部仓库`（external）在WORKSPACE中定义

#### Packages

* 目录包含`BUILD`或`BUILD.bazel`文件
* `文件`和`依赖关系`的集合

#### Targets

* package包含的元素，主要是`文件`或`规则`

#### Labels

target的名称，格式为`@repositrory_name//package_name:target_name`：

```
@myrepo//my/app/main:app_binary
//my/app/main:app_binary    #同一个仓库
//my/app:app
//my/app     #同上
```



#### Rules

* 指明输入文件和输出文件的关系
* 生成输出文件的步骤

## WORKSPACE规则

Workspace规则主要用来解决外部依赖

#### bind

在//external中为目标指定一个别名。不推荐使用。

#### local_repository

引用其他目录中的目标

```
local_repository(
    name = "my-ssl",
    path = "/home/user/ssl",
)
```

可以指定`@my-ssl//src:openssl-lib`作为这个库的依赖。

#### new_local_repository

把本地目录变成一个Bazel仓库。

比如聊天app代码目录在*/chat-app*，要用的SSL库在*～/ssl*。

1、添加*~/chat-app/BUILD.my-ssl*：

```
java_library(
    name = "openssl",
    srcs = glob(['*.java'])
    visibility = ["//visibility:public"],
)
```

2、在~/chat-app/WORKSPACE加上：

```
new_local_repository(
    name = "my-ssl",
    path = "/home/user/ssl",
    build_file = "BUILD.my-ssl",
)
```

然后就可以把`@my-ssl//:openssl`添加到目标的依赖。



## BUILD文件



## C/C++规则

#### cc_binary

```bazel
cc_binary(
    name = "hello-world",
    srcs = ["hello-world.cc"],
)
```

#### cc_import

#### cc_library

#### cc_proto_library

#### fdo_prefetch_hints

#### fdo_profile

#### propeller_optimize

#### cc_test

#### cc_toolchain

#### cc_toolchain_suite



## 文档链接

* [Concepts and Terminology](https://docs.bazel.build/versions/master/build-ref.html)
* [Workspace Rules](https://docs.bazel.build/versions/master/be/workspace.html)

